\chapter{The Data} \label{chap:data}

\section{Introduction}

%TODO discuss SLOW5 format and how using v0.2.0

\input{plots/reads.e9f08690-171f-476f-9119-5330d0290126.raw.pa.small}

The data consists of many sequences of unsigned integers known as \textit{reads} and their associated metadata. Each read represents the quantised ionic current measured across a nanopore as a single-stranded DNA or RNA molecule is driven through it. The current is typically recorded or `sampled' 4000 times a second by an electrode in the sensor chip and digitised using an analogue-to-digital converter (ADC). This recording frequency is known as the \textit{sampling rate} and is stored as metadata for each read. Disturbances in the ionic current caused by the molecule's biological structure can be used to determine its nucleic acid sequence.

Let each read (or `raw signal') be represented by
\[ x := (x_i\mid x_i \in \mathbb{Z} \cap [0, 2^{16})) \]
where $i\in \mathbb{Z}\cap [0, n)$. Computationally, $x$ is an unsigned 16-bit integer array with $n$ elements. However, in practice the full range of $2^{16}$ integers is never met. A property which will be further explored and heavily exploited. See Figure \ref{fig:read-e9f-pa} for an example of a read.

There are many metadata fields which are constant for all reads of the same sequencing run. This includes the sampling rate and every header attribute. Common header attributes include metadata relating to the ASIC chip such as its temperature at the start of the run, the ONT device being used, the start time of the run, its duration in minutes and whether DNA or RNA is being used \cite{slow5-spec}. See Table \ref{tab:data-meta}.

\input{plots/data-meta}
\input{plots/data-read-meta}

The main read-variable metadata is the length $n$ and the information necessary for converting the read from quantised raw signal values into picoamperes (pA). This information is comprised of three fields: the digitisation, offset and range. The digitisation is the number of quantisation levels in the ADC which is typically 2048 ($2^{11}$) or 4096 ($2^{12}$). I believe this is why each data point in a read is recorded using 16 bits; it is the closest multiple of a byte after 11 and 12 bits. The next field is the offset which is the ADC's offset error whilst the range is the sensor chip's full measurement range in picoamperes. To convert a raw signal value into picoamperes one does the following computation
\begin{equation}(raw + offset) \times \frac{range}{digitisation}. \label{eq:pa}\end{equation}
The digitisation and range fields are actually constant between reads since they are hardware-defined properties; it is the offset which varies among reads. See Table \ref{tab:data-read-meta}.

There are other read-variable metadata fields which are optionally included in the data but nonetheless may prove useful for a compression algorithm. These include the reason the read ended, flow cell location data comprised of the channel and pore number, the estimated median current level before the start of the read, and a count of the number of reads and data points previously recorded by the channel.

For the remainder of the thesis, the data which we will use for analysing the characteristics of nanopore signal data and for comparing compression methods is a downsampling of a $\sim$30$\times$ NA12878 data set. The NA12878 data set has been well studied and is used prolifically for benchmarking genomics tools. It originates from a Utah woman whose DNA reference was artificially recreated, treated using a short read eliminator kit and sequenced on an ONT PromethION 48 using two version R9.4.1 flow cells to obtain $\sim$30$\times$ coverage of her genome.
The data set was then downsampled a factor of $\sim$18 by obtaining the first \num{500000} reads.
%The data set was then downsampled a factor of $\sim$18 by obtaining the sequence of reads requested by a typical analysis application.
%More specifically, it was generated by sorting the reads by chromosome number and then base location to obtain a sorted order of reads by genomic coordinates.
%Downsampling produces a smaller representative data set which speeds up testing, and the results found should scale up to the whole data set.
The first reads usually contain more data than later reads as each nanopore deteriorates over its sequencing lifetime.
Downsampling produces a smaller data set which speeds up testing, and the compression results found should scale up to the whole data set.

It is highly likely that human DNA is the most commonly sequenced molecule of all sequencing technologies, as well as specifically of ONT devices.
Naturally then, most data sets that exist are the result of sequencing human DNA and hence share patterns inherit in human biology and the DNA sequencing process.
Hence, it makes sense to consider a human DNA data set in a study of data compression.
Furthermore, the PromethION flow cell produces the most yield out of all ONT flow cells so PromethION data is also highly suitable.
Thus, the NA12878 data set is a good choice for the comparison of nanopore signal compression methods.

The original data set contains \num{9083052} reads and consumes $\sim$2 TiB in raw binary or $\sim$707 GiB using VBZ compression. After downsampling, the data set contains \num{500000} reads and $\sim$57 billion data points, consuming $\sim$106 GiB in raw binary or $\sim$37 GiB when stored using VBZ. See Tables \ref{tab:data-orig} and \ref{tab:data} for an overview of the data sets. From now onwards, \textit{the data set} refers to the downsampling of the original NA12878 data set.

\input{plots/data-orig-tab}
\input{plots/data-tab}

The metadata accounts for lesser than 0.05\% of the raw binary data set's size, meaning that without storing any metadata the data set consumes roughly the same size. From a compression point of view there is much more to gain from focussing on compressing the read data. For this reason, future comparisons of file size including compression ratios will not represent the cost of storing metadata, only read data.

The raw signal values in the data set range from 158 to 1748 with a median of 474 and standard deviation of $\sim$ 35. See Table \ref{tab:rawsig}. The range is 1590 but the middle 99\% of the data ranges from 350 to 622. Figure \ref{fig:data-hist} shows the singular-width bin histogram of the raw signal values between 295 and 687.
As one can observe, the distribution is fairly symmetric around the centre with the median and mean very close to one another. However, it is slightly right-skewed with its right tail extending much further than its left. This is most evident by observing that the maximum is more than four times further from the median than the minimum is.
Most interestingly, the histogram is not smooth with the frequency of adjacent signal points varying drastically. For example, the value 455 occurs $\sim$6.3 times more often than 456.
In fact, on close inspection there is a cyclical pattern in the relative frequency of adjacent signal points in Figure \ref{fig:data-hist} which appears to repeats every 16 values. For example, consider the frequencies of values 456--471 and values 472--487.
%TODO put closeup figure showing pattern
This is most likely a result of the ADC unevenly digitising the analogue ionic current signal in some deterministic way.

\input{plots/rawsig-tab}
\input{plots/freq}

The read lengths range from 2024 to \num{5724000} with a median of 80304.5. See Table \ref{tab:n} for an overview and Figure \ref{fig:n-hist} for the histogram with bin width one. As one can observe, there are a lot of large read lengths which skew the distribution to the right.

\input{plots/n-tab}
\input{plots/nhist}

\section{Characteristics}

We will now discuss the characteristics of the data -- human DNA reads. General DNA/RNA reads should exhibit similar properties but there are several differences and the primary focus of this thesis is human DNA data.

Each read consists of several sections with recognisable characteristics; the surge, stall, pre-adapter surge, adapter, DNA, homopolymer and slow sections. Figure \ref{fig:start-sections} shows the beginning of a read with the surge, stall, pre-adapter surge and adapter sections delimited.

The surge typically consists of one signal at the beginning of the read which is significally above the median. The pore is most likely in its open state (no molecules within it) at the time of recording and MinKNOW, the recording software, has failed to completely trim the pre-data section. This results in a large current surge since there are no DNA molecules being kinetically propelled by the electric field.
% TODO analyse surge section

The stall also occurs at the beginning of the read and after the surge if it exists. It consists of hundreds to thousands of data points which oscillate with small variation around the median of the read. This section is rarely missing from the read and possibly occurs due to the motor protein stalling before beginning to unwind the molecule.
% TODO analyse stall lengths

The adapter sequence is the first DNA sequence recorded in the signal data. The adapter connects the motor protein to the DNA strand and has a predictable molecular sequence which differs from sequencing kit to kit. There is typically a surge between the stall and the adapter section consisting of several signal values which we will name the \textit{pre-adapter surge}.

\input{plots/start-sections}

The DNA sections are the typical data sections of a read and store information necessary for determining the original DNA sequence. This type of section accounts for the large majority of data points in a typical read. Characteristically, DNA sections oscillate in smaller low-variance sections of 10--100 data points with steep transitions between them. The adapter sequence is quite similar in behaviour since it also represents molecular information. See Figure \ref{fig:dna-section} for an example.

\input{plots/dna-section}

The homopolymer and slow sections typically occur infrequently at random positions in the read and consist of hundreds to thousands of data points which oscillate with small variation around some value. See Figures \ref{fig:homo-section} and \ref{fig:slow-section} respectively. This is quite similar to the stall section except that the stall oscillates near the median value of the read, whilst the homopolyer and slow sections can occur at any feasible value. The difference between the homopolymer and slow sections is that the homopolymer section represents the repetition of one or more DNA bases, whilst the slow section represents several DNA bases which are moving through the nanopore relatively slowly, or have gotten temporarily stuck, and so are recorded over many more data points than usual. There is sometimes a slow-like section which terminates the read as well.
%TODO show terminating stall

\input{plots/homo-section}
\input{plots/slow-section}

However predictable some of these sections are, each read can have strange unpredictable behaviour. For example, a sudden significant shift in values can be seen in Figure \ref{fig:mess-section}. Whilst, an unexpected drop terminates the read in Figure \ref{fig:read-515}.

\input{plots/mess-section}
\input{plots/reads.515e4fd0-8ab1-4845-8866-6772e779712b.raw.wrap}

\section{Transformations}

\input{plots/trans-tab}

\input{plots/reads.e9f08690-171f-476f-9119-5330d0290126.raw.delta.small}

%in Section \ref{sec:}
As previously discussed, differential coding has been applied with great success to the compression of nanopore signal data.
Let's now consider the deltas between each read data point. Figure \ref{fig:read-e9f-delta} plots the differential encoding of the read with ID e9f08690-171f-476f-9119-5330d0290126. In comparison to the standard representation, as shown in Figure \ref{fig:read-e9f-pa}, differential coding removes inconsistent shifts in the data such that it has fewer repeated outliers. For example, the upward shift around position 50000 in Figure \ref{fig:read-e9f-pa} is no longer clearly evident in the differential encoding.
% TODO plot of the shift before and after diff encoding
The deltas range from $-1159$ to 913 with a median, mean and mode of 0, and a standard deviation of $\sim$13. See Table \ref{tab:trans}.
The middle 99\% lies tightly in the range from $-46$ to 63 in a normal-like distribution. See Figure \ref{fig:delta-hist} for a histogram of the deltas.
Interestingly, $-2$ occurs $\sim23\times 10^6$ more times than $-1$ which is likely a result of the ADC.

Also, notice that there are more small negative than positive deltas in the histogram. This implies that there are more small decreases in the signal than increases.
\label{subsec:prob}
Next, notice that the right tail extends much further than the left tail in the histogram. This suggests that there are significantly more large positive than negative deltas. In other words, there are more large jumps in the signal than falls.
In fact, the probability that a delta is lesser than $-128$ and greater than 127 is $\sim6.0\times 10^{-6}$ and $\sim3.7\times 10^{-5}$ respectively. Combining both probabilities we find that the probability that a delta is outside of the signed 1 byte range is $\sim$0.004\%. This is very small and will be exploited in section \ref{sec:vbbe21}.

\input{plots/diff-hist}

\input{plots/reads.e9f08690-171f-476f-9119-5330d0290126.raw.delta.zigzag.small}

The zig-zag deltas (deltas then zig-zag encoding) range from 0 to 2317 with a median of 4, mean of $\sim15.5679$ and standard deviation of $\sim20.6060$. See Table \ref{tab:trans}. The zig-zag encoding interleaves the positive and negative deltas resulting in a geometric-like distribution which is not completely decreasing. See Figure \ref{fig:zd-hist}. Notice the `dotted' right tail; every box with an even offset from value 150 onwards is much larger than those with an odd offset. This is due to the higher frequency of large positive deltas in comparison to large negative deltas, as discussed above.

\input{plots/zd-hist}

% submin
% zsubmean
% zsubmedian
